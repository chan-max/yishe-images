<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ImageMagick 图像处理服务控制台</title>
  <!-- Semantic UI CSS -->
  <link rel="stylesheet" href="/lib/semantic.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css">
  <!-- jQuery (Semantic UI 依赖) -->
  <script src="/lib/jquery.js"></script>
  <!-- Vue 3 & axios -->
  <script src="/lib/vue.js"></script>
  <script src="/lib/axios.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      font-size: 13px;
    }
    .app-layout {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 220px;
      background: #1b1c1d;
      color: #fff;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 1000;
    }
    .sidebar-header {
      padding: 1rem 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar-header h2 {
      color: #fff;
      margin: 0;
      font-size: 1rem;
    }
    .sidebar-menu {
      padding: 0.5rem 0;
    }
    .menu-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: rgba(255, 255, 255, 0.8);
      border-left: 3px solid transparent;
    }
    .menu-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    .menu-item.active {
      background-color: rgba(33, 133, 208, 0.2);
      color: #fff;
      border-left-color: #2185d0;
    }
    .menu-item i {
      width: 20px;
      text-align: center;
    }
    .main-content {
      flex: 1;
      margin-left: 220px;
      margin-right: 360px;
      padding: 1rem 1.5rem;
    }
    .section {
      margin-bottom: 2rem;
    }
    .debug-panel {
      width: 360px;
      background: #fff;
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 999;
      border-left: 1px solid #e0e0e0;
      box-shadow: -2px 0 4px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }
    .debug-panel-header {
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
      background: #f9f9f9;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .debug-panel-content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    .debug-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 0.5rem;
    }
    .debug-tab {
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85em;
      transition: background-color 0.2s;
      color: #666;
    }
    .debug-tab:hover {
      background-color: #f0f0f0;
    }
    .debug-tab.active {
      background-color: #2185d0;
      color: #fff;
    }
    .debug-log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 0.75rem;
      border-radius: 4px;
      font-family: "Consolas", "Monaco", "Courier New", monospace;
      font-size: 0.75rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: calc(100vh - 280px);
      overflow-y: auto;
    }
    .debug-log-item {
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .debug-log-item:last-child {
      border-bottom: none;
    }
    .debug-log-time {
      color: #888;
      font-size: 0.7em;
      margin-bottom: 0.25rem;
    }
    .debug-log-content {
      color: #d4d4d4;
    }
    .debug-log-content.error {
      color: #f44336;
    }
    .debug-log-content.success {
      color: #4caf50;
    }
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9em;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
    }
    .status-dot.ok {
      background: #21ba45;
    }
    .status-dot.fail {
      background: #db2828;
    }
    .form-field {
      display: flex;
      flex-direction: column;
    }
    .form-field label {
      margin-bottom: 0.4rem;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.87);
      font-size: 0.9em;
    }
    .ui.header {
      font-size: 1.15em;
    }
    .ui.header .sub.header {
      font-size: 0.85em;
    }
    .ui.segment {
      padding: 0.875rem;
    }
    .ui.segment h3 {
      font-size: 1.1em;
      margin-bottom: 0.75rem;
    }
    .ui.button {
      font-size: 0.9em;
      padding: 0.6em 1em;
    }
    .ui.input input,
    .ui.input textarea,
    .ui.dropdown {
      font-size: 0.9em;
    }
    .view-container {
      display: none;
    }
    .view-container.active {
      display: block;
    }
    .image-preview {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin: 1rem 0;
    }
    .upload-area {
      border: 2px dashed #2185d0;
      border-radius: 6px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f9f9f9;
    }
    .upload-area:hover {
      border-color: #1678c2;
      background: #f0f0f0;
    }
    .upload-area.dragover {
      border-color: #1678c2;
      background: #e8f4f8;
    }
    .upload-area i {
      font-size: 2em !important;
      margin-bottom: 0.5rem !important;
    }
    .upload-area p {
      margin: 0.25rem 0 !important;
      font-size: 0.9em !important;
    }
    .compact-form {
      margin-bottom: 1rem;
    }
    .compact-form h4 {
      font-size: 0.95em;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e0e0e0;
    }
    .compact-form .field {
      margin-bottom: 0.75rem;
    }
    .compact-form .field:last-child {
      margin-bottom: 0.5rem;
    }
    .compact-segment {
      padding: 0.75rem !important;
      margin-bottom: 1rem !important;
    }
    .compact-segment h3 {
      font-size: 1em !important;
      margin-bottom: 0.75rem !important;
    }
    .image-preview {
      max-width: 100%;
      max-height: 250px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin: 0.5rem 0;
    }
    .image-comparison-container {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }
    .image-comparison-item {
      flex: 1;
      text-align: center;
    }
    .image-comparison-item img {
      width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .compact-grid {
      margin: 0.5rem 0 !important;
    }
    .compact-grid .column {
      padding: 0.5rem !important;
    }
    .compact-card {
      margin: 0 !important;
    }
    .compact-card .content {
      padding: 0.75rem !important;
    }
    .compact-card .header {
      font-size: 0.9em !important;
      margin-bottom: 0.5rem !important;
    }
    .compact-list .item {
      padding: 0.5rem 0 !important;
    }
    .compact-list .item .header {
      font-size: 0.85em !important;
    }
    .compact-list .item .description {
      font-size: 0.8em !important;
    }
    .collapsible-section {
      margin-bottom: 0.75rem;
    }
    .collapsible-header {
      cursor: pointer;
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.2s;
    }
    .collapsible-header:hover {
      background: #e8e8e8;
    }
    .collapsible-header i {
      transition: transform 0.3s;
    }
    .collapsible-header.collapsed i {
      transform: rotate(-90deg);
    }
    .collapsible-content {
      padding: 0.75rem;
      border-top: 1px solid #e0e0e0;
    }
    .collapsible-content.collapsed {
      display: none;
    }
    .code-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 0.75rem;
      border-radius: 4px;
      font-family: "Consolas", "Monaco", "Courier New", monospace;
      font-size: 0.75rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    @media (max-width: 1200px) {
      .debug-panel {
        display: none;
      }
      .main-content {
        margin-right: 0;
      }
    }
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }
    /* 文件预览弹窗样式 */
    .file-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 2rem;
    }
    .file-preview-content {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .file-preview-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      background: #f9f9f9;
    }
    .file-preview-body {
      padding: 1.5rem;
      overflow: auto;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      max-height: calc(90vh - 150px);
    }
    .file-preview-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e0e0e0;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="app-layout">
      <!-- 左侧菜单 -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <h2>
            <i class="image icon"></i>
            ImageMagick 服务
          </h2>
        </div>
        <div class="sidebar-menu">
          <div 
            v-for="item in menuItems" 
            :key="item.id"
            class="menu-item"
            :class="{ active: state.currentView === item.id }"
            @click="switchView(item.id)"
          >
            <i :class="item.icon + ' icon'"></i>
            <span>{{ item.name }}</span>
          </div>
        </div>
      </aside>

      <!-- 右侧主体内容 -->
      <main class="main-content">
        <!-- 首页/使用指南 -->
        <div class="view-container" :class="{ active: state.currentView === 'home' }">
          <div class="section">
            <h1 class="ui header">
              <i class="book icon"></i>
              <div class="content">
                使用指南
                <div class="sub header">了解如何使用 ImageMagick 图像处理服务</div>
              </div>
            </h1>

            <div class="ui two column grid">
              <div class="column">
                <div class="ui segment">
                  <h3 class="ui header">操作步骤</h3>
                  <ol class="ui list">
                    <li>先进行健康检查，确认 ImageMagick 已安装。</li>
                    <li>上传图片文件（支持拖拽上传）。</li>
                    <li>选择需要的操作（调整大小、裁剪、旋转等）。</li>
                    <li>设置参数并执行操作。</li>
                    <li>查看处理结果并下载。</li>
                  </ol>
                </div>
              </div>
              <div class="column">
                <div class="ui segment">
                  <h3 class="ui header">注意事项</h3>
                  <ul class="ui list">
                    <li>确保 ImageMagick 已正确安装并在系统 PATH 中</li>
                    <li>支持格式：JPG, PNG, GIF, BMP, WEBP, SVG, TIFF</li>
                    <li>上传文件大小限制：100MB</li>
                    <li>处理后的文件保存在 output 目录</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 服务配置 -->
        <div class="view-container" :class="{ active: state.currentView === 'config' }">
          <div class="section">
            <h1 class="ui header">
              <i class="cog icon"></i>
              <div class="content">
                服务配置
                <div class="sub header">配置服务和检测 ImageMagick 状态</div>
              </div>
            </h1>

            <div class="ui segment">
              <h3 class="ui dividing header">服务操作</h3>
              <div class="ui small buttons">
                <button class="ui small button" :class="{ loading: state.loading.health }" @click="checkHealth" :disabled="state.loading.health">
                  健康检查
                </button>
                <button class="ui small primary button" :class="{ loading: state.loading.checkIm }" @click="checkImageMagick" :disabled="state.loading.checkIm">
                  检测 ImageMagick
                </button>
              </div>
              <div style="margin-top: 1rem;">
                <span class="status-indicator">
                  <span class="status-dot" :class="{'ok': state.healthOk, 'fail': state.healthOk === false}"></span>
                  <span>健康状态：{{ state.healthOk === null ? '未知' : (state.healthOk ? '正常' : '异常') }}</span>
                </span>
                <div v-if="state.imagemagickStatus" style="margin-top: 0.5rem;">
                  <span class="status-indicator">
                    <span class="status-dot" :class="{'ok': state.imagemagickStatus.installed, 'fail': !state.imagemagickStatus.installed}"></span>
                    <span>{{ state.imagemagickStatus.message }}</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 图片分析 -->
        <div class="view-container" :class="{ active: state.currentView === 'analyze' }">
          <div class="section">
            <h1 class="ui header">
              <i class="search icon"></i>
              <div class="content">
                图片分析
                <div class="sub header">上传图片并查看详细信息</div>
              </div>
            </h1>

            <!-- 上传区域 -->
            <div class="ui segment compact-segment">
              <h3 class="ui dividing header" style="font-size: 0.95em; margin-bottom: 0.75rem;">上传图片</h3>
              
              <!-- 统一输入框 -->
              <div class="ui form">
                <div class="field" style="margin-bottom: 0.75rem;">
                  <label style="font-size: 0.85em; margin-bottom: 0.25rem;">图片地址（网络 URL 或选择本地文件）</label>
                  <div class="ui action input" style="font-size: 0.9em;">
                    <input type="text" v-model="state.analyzeImageUrl" placeholder="输入网络图片 URL" @keyup.enter="handleAnalyzeUrlUpload" style="font-size: 0.9em;">
                    <button class="ui primary button" :class="{ loading: state.loading.analyzeUrlUpload }" @click="handleAnalyzeUrlUpload" :disabled="!state.analyzeImageUrl || state.loading.analyzeUrlUpload" style="font-size: 0.85em; padding: 0.5em 0.75em;">
                      <i class="download icon"></i> 加载
                    </button>
                  </div>
                  <p style="color: #999; font-size: 0.8em; margin-top: 0.5rem;">支持 JPG, PNG, GIF, BMP, WEBP, SVG, TIFF</p>
                </div>
              </div>
            </div>

            <!-- 图片预览和信息 -->
            <div v-if="state.analyzeImage || state.analyzeImageInfo" class="ui segment compact-segment">
              <h3 class="ui dividing header" style="font-size: 0.95em; margin-bottom: 0.75rem;">图片信息</h3>
              
              <!-- 图片预览 -->
              <div v-if="state.analyzeImage" style="text-align: center; margin-bottom: 0.75rem;">
                <img :src="state.analyzeImage" class="image-preview" alt="分析图片">
              </div>

              <!-- 详细信息 -->
              <div v-if="state.analyzeImageInfo" class="ui two column grid compact-grid">
                <div class="column">
                  <div class="ui card compact-card">
                    <div class="content">
                      <div class="header">基本信息</div>
                      <div class="description" style="margin-top: 0.5rem;">
                        <div class="ui relaxed list compact-list">
                          <div class="item">
                            <i class="file image icon" style="font-size: 0.9em;"></i>
                            <div class="content">
                              <div class="header">格式</div>
                              <div class="description">{{ state.analyzeImageInfo.format || '未知' }}</div>
                            </div>
                          </div>
                          <div class="item">
                            <i class="expand arrows alternate icon" style="font-size: 0.9em;"></i>
                            <div class="content">
                              <div class="header">尺寸</div>
                              <div class="description">
                                {{ state.analyzeImageInfo.width || 0 }} × {{ state.analyzeImageInfo.height || 0 }} px
                              </div>
                            </div>
                          </div>
                          <div class="item">
                            <i class="hdd icon" style="font-size: 0.9em;"></i>
                            <div class="content">
                              <div class="header">文件大小</div>
                              <div class="description">{{ formatFileSize(state.analyzeImageInfo.size || 0) }}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="ui card compact-card">
                    <div class="content">
                      <div class="header">技术信息</div>
                      <div class="description" style="margin-top: 0.5rem;">
                        <div class="ui relaxed list compact-list">
                          <div class="item">
                            <i class="palette icon" style="font-size: 0.9em;"></i>
                            <div class="content">
                              <div class="header">颜色空间</div>
                              <div class="description">{{ state.analyzeImageInfo.colorspace || '未知' }}</div>
                            </div>
                          </div>
                          <div class="item">
                            <i class="layer group icon" style="font-size: 0.9em;"></i>
                            <div class="content">
                              <div class="header">位深度</div>
                              <div class="description">{{ state.analyzeImageInfo.depth || '未知' }}</div>
                            </div>
                          </div>
                          <div class="item" v-if="state.analyzeFilename">
                            <i class="file outline icon" style="font-size: 0.9em;"></i>
                            <div class="content">
                              <div class="header">文件名</div>
                              <div class="description" style="word-break: break-all; font-size: 0.75em;">{{ state.analyzeFilename }}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 详细信息 JSON -->
              <div v-if="state.analyzeImageInfo" style="margin-top: 0.75rem;">
                <div class="collapsible-section">
                  <div class="collapsible-header" :class="{ collapsed: state.analyzeJsonCollapsed }" @click="state.analyzeJsonCollapsed = !state.analyzeJsonCollapsed">
                    <span style="font-size: 0.9em; font-weight: 500;">详细信息 (JSON)</span>
                    <div>
                      <button class="ui mini button" @click.stop="copyAnalyzeInfo" style="margin-right: 0.5rem; padding: 0.3em 0.5em;">
                        <i class="copy icon"></i> 复制
                      </button>
                      <i class="chevron down icon"></i>
                    </div>
                  </div>
                  <div class="collapsible-content" :class="{ collapsed: state.analyzeJsonCollapsed }">
                    <pre class="code-output" style="max-height: 200px; overflow-y: auto; margin: 0;">{{ JSON.stringify(state.analyzeImageInfo, null, 2) }}</pre>
                  </div>
                </div>
              </div>

              <!-- 操作按钮 -->
              <div v-if="state.analyzeImage" style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                <button class="ui small primary button" @click="useAnalyzeImageForProcess" style="flex: 1;">
                  <i class="arrow right icon"></i> 用于处理
                </button>
                <button class="ui small button" @click="clearAnalyzeImage" style="flex: 1;">
                  <i class="trash icon"></i> 清除
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 链式处理 -->
        <div class="view-container" :class="{ active: state.currentView === 'chain-process' }">
          <div class="section">
            <h1 class="ui header">
              <i class="sitemap icon"></i>
              <div class="content">
                链式图片处理
                <div class="sub header">按顺序执行多个图片处理操作</div>
              </div>
            </h1>

            <!-- 图片输入区域 -->
            <div class="ui segment compact-segment">
              <h3 class="ui dividing header" style="font-size: 0.95em; margin-bottom: 0.75rem;">图片输入</h3>
              
              <div class="ui form">
                <div class="field" style="margin-bottom: 0.75rem;">
                  <label style="font-size: 0.85em; margin-bottom: 0.25rem;">图片地址（支持本地文件名或网络 URL）</label>
                  <input type="text" v-model="state.chainProcessImageUrl" placeholder="输入文件名（如：1234567890-123456789.jpg）或网络 URL（如：https://example.com/image.jpg）" @keyup.enter="handleChainProcess" @input="updateChainProcessImagePreview" style="font-size: 0.9em;">
                  <p style="color: #999; font-size: 0.8em; margin-top: 0.5rem;">
                    支持本地文件名（位于 uploads 目录）或网络图片 URL（自动下载）。格式：JPG, PNG, GIF, BMP, WEBP, SVG, TIFF
                  </p>
                </div>
              </div>
              
              <div v-if="state.chainProcessImage" style="margin-top: 0.75rem;">
                <img :src="state.chainProcessImage" class="image-preview" alt="当前图片">
                <div class="ui small message" style="padding: 0.5rem; margin-top: 0.5rem;">
                  <p style="margin: 0.25rem 0; font-size: 0.85em;"><strong>当前图片:</strong> {{ state.chainProcessImageUrl || state.chainProcessFilename }}</p>
                  <p v-if="state.chainProcessImageInfo" style="margin: 0.25rem 0; font-size: 0.85em;">
                    <strong>尺寸:</strong> {{ state.chainProcessImageInfo.width }} × {{ state.chainProcessImageInfo.height }} px
                  </p>
                </div>
              </div>
            </div>

            <!-- 操作链配置 -->
            <div class="ui segment compact-segment">
              <h3 class="ui dividing header" style="font-size: 0.95em; margin-bottom: 0.75rem;">
                操作链配置
                <button class="ui mini button" @click="state.operationChain = []" style="float: right;">
                  <i class="trash icon"></i> 清空
                </button>
              </h3>
              
              <!-- 添加操作 -->
              <div class="ui form" style="margin-bottom: 1rem;">
                <div class="field">
                  <label>添加操作</label>
                  <div class="ui action input" style="display: flex;">
                    <select v-model="state.selectedOperationType" class="ui dropdown" style="flex: 1; min-width: 0;">
                      <option value="">请选择操作类型</option>
                      <option v-for="op in operationTypes" :key="op.value" :value="op.value">
                        {{ op.label }} - {{ op.description }}
                      </option>
                    </select>
                    <button class="ui primary button" @click="addSelectedOperation" :disabled="!state.selectedOperationType" style="margin-left: 0.5rem;">
                      <i class="plus icon"></i> 添加
                    </button>
                  </div>
                </div>
              </div>

              <!-- 操作列表 Tab -->
              <div v-if="state.operationChain.length > 0">
                <!-- Tab 标签栏 -->
                <div style="overflow-x: auto; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0;">
                  <div style="display: flex; min-width: max-content; overflow-y: hidden; gap: 0.5rem;">
                    <div 
                      v-for="(operation, index) in state.operationChain" 
                      :key="operation.id"
                      @click="selectOperation(index)"
                      :class="['ui', 'button', { 'primary': state.selectedOperationIndex === index }]"
                      style="white-space: nowrap; border-radius: 4px 4px 0 0; margin-bottom: -2px; border-bottom: 2px solid transparent;"
                      :style="{ 'border-bottom-color': state.selectedOperationIndex === index ? '#2185d0' : 'transparent' }"
                    >
                      <span style="margin-right: 0.5rem;">{{ index + 1 }}. {{ getOperationLabel(operation) }}</span>
                      <button 
                        class="ui mini icon button" 
                        @click.stop="removeOperationWithIndex(index)"
                        style="padding: 0.3em; margin-left: 0.25rem;"
                      >
                        <i class="close icon"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- 当前选中操作的配置 -->
                <div v-if="state.operationChain.length > 0 && state.selectedOperationIndex >= 0 && state.selectedOperationIndex < state.operationChain.length" class="ui segment" style="padding: 0.75rem;">
                  <div style="display: flex; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e0e0e0;">
                    <div style="flex: 1;">
                      <span style="font-weight: bold; margin-right: 0.5rem;">{{ state.selectedOperationIndex + 1 }}. {{ getOperationLabel(state.operationChain[state.selectedOperationIndex]) }}</span>
                      <p style="font-size: 0.85em; color: #666; margin: 0.25rem 0 0 0;">{{ getOperationDescription(state.operationChain[state.selectedOperationIndex]) }}</p>
                    </div>
                    <div class="ui mini buttons" style="margin-left: auto;">
                      <button class="ui button" @click="moveOperationUp(state.selectedOperationIndex)" :disabled="state.selectedOperationIndex === 0">
                        <i class="arrow up icon"></i>
                      </button>
                      <button class="ui button" @click="moveOperationDown(state.selectedOperationIndex)" :disabled="state.selectedOperationIndex === state.operationChain.length - 1">
                        <i class="arrow down icon"></i>
                      </button>
                    </div>
                  </div>
                  
                  <!-- 操作参数配置 -->
                  <div class="ui form">
                    <template v-if="state.operationChain[state.selectedOperationIndex].type === 'resize'">
                      <div class="two fields">
                        <div class="field">
                          <label>宽度 <span style="color: #999; font-weight: normal;">(像素)</span></label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.width" placeholder="宽度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">目标图片宽度，范围：1-10000，推荐：800-1920</p>
                        </div>
                        <div class="field">
                          <label>高度 <span style="color: #999; font-weight: normal;">(像素)</span></label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.height" placeholder="高度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">目标图片高度，范围：1-10000，推荐：600-1080</p>
                        </div>
                      </div>
                      <div class="field">
                        <div class="ui checkbox">
                          <input type="checkbox" v-model="state.operationChain[state.selectedOperationIndex].params.maintainAspectRatio">
                          <label>保持宽高比</label>
                        </div>
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">勾选后按比例缩放，不勾选则强制拉伸到目标尺寸（可能变形）</p>
                      </div>
                      <div class="field">
                        <label>质量 <span style="color: #999; font-weight: normal;">(%)</span></label>
                        <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.quality" min="1" max="100" placeholder="质量 (1-100)">
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">图片压缩质量，范围：1-100，推荐：85-95（数值越高质量越好但文件越大）</p>
                      </div>
                    </template>
                    
                    <template v-else-if="state.operationChain[state.selectedOperationIndex].type === 'crop'">
                      <div class="two fields">
                        <div class="field">
                          <label>X坐标 <span style="color: #999; font-weight: normal;">(像素)</span></label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.x" placeholder="X坐标">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">裁剪区域左上角的X坐标，范围：0-图片宽度，推荐：从0开始</p>
                        </div>
                        <div class="field">
                          <label>Y坐标 <span style="color: #999; font-weight: normal;">(像素)</span></label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.y" placeholder="Y坐标">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">裁剪区域左上角的Y坐标，范围：0-图片高度，推荐：从0开始</p>
                        </div>
                      </div>
                      <div class="two fields">
                        <div class="field">
                          <label>宽度 <span style="color: #999; font-weight: normal;">(像素)</span></label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.width" placeholder="宽度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">裁剪区域的宽度，范围：1-图片宽度，需确保 X+宽度 ≤ 图片宽度</p>
                        </div>
                        <div class="field">
                          <label>高度 <span style="color: #999; font-weight: normal;">(像素)</span></label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.height" placeholder="高度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">裁剪区域的高度，范围：1-图片高度，需确保 Y+高度 ≤ 图片高度</p>
                        </div>
                      </div>
                    </template>
                    
                    <template v-else-if="state.operationChain[state.selectedOperationIndex].type === 'shapeCrop'">
                      <div class="field">
                        <label>形状</label>
                        <select v-model="state.operationChain[state.selectedOperationIndex].params.shape" class="ui dropdown">
                          <option value="circle">圆形</option>
                          <option value="ellipse">椭圆</option>
                          <option value="star">五角星</option>
                          <option value="triangle">三角形</option>
                          <option value="diamond">菱形</option>
                          <option value="heart">心形</option>
                          <option value="hexagon">六边形</option>
                          <option value="octagon">八边形</option>
                        </select>
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">选择裁剪的形状类型，推荐：圆形、椭圆</p>
                      </div>
                      <div class="two fields">
                        <div class="field">
                          <label>宽度 <span style="color: #999; font-weight: normal;">(像素)</span></label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.width" placeholder="宽度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">形状的宽度，范围：1-图片宽度，推荐：200-800</p>
                        </div>
                        <div class="field">
                          <label>高度 <span style="color: #999; font-weight: normal;">(像素)</span></label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.height" placeholder="高度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">形状的高度，范围：1-图片高度，推荐：200-800（圆形时建议与宽度相同）</p>
                        </div>
                      </div>
                      <div class="two fields">
                        <div class="field">
                          <label>中心 X 坐标（留空则居中）</label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.x" placeholder="居中">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">形状中心的X坐标，留空则自动居中，范围：0-图片宽度</p>
                        </div>
                        <div class="field">
                          <label>中心 Y 坐标（留空则居中）</label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.y" placeholder="居中">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">形状中心的Y坐标，留空则自动居中，范围：0-图片高度</p>
                        </div>
                      </div>
                      <div class="field">
                        <label>背景颜色</label>
                        <input type="text" v-model="state.operationChain[state.selectedOperationIndex].params.backgroundColor" placeholder="transparent">
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">形状外的背景颜色，支持颜色名称（如 transparent、white）或十六进制（如 #FFFFFF），推荐：transparent（透明）</p>
                      </div>
                    </template>
                    
                    <template v-else-if="state.operationChain[state.selectedOperationIndex].type === 'rotate'">
                      <div class="field">
                        <label>角度 <span style="color: #999; font-weight: normal;">(度)</span></label>
                        <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.degrees" placeholder="角度">
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">旋转角度，范围：-360 到 360，正数为顺时针，负数为逆时针，推荐：90、180、270</p>
                      </div>
                      <div class="field">
                        <label>背景色</label>
                        <input type="text" v-model="state.operationChain[state.selectedOperationIndex].params.backgroundColor" placeholder="#000000">
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">旋转后空白区域的背景颜色，支持颜色名称或十六进制（如 #000000、white），推荐：#000000（黑色）或 transparent（透明）</p>
                      </div>
                    </template>
                    
                    <template v-else-if="state.operationChain[state.selectedOperationIndex].type === 'convert'">
                      <div class="field">
                        <label>格式</label>
                        <select v-model="state.operationChain[state.selectedOperationIndex].params.format" class="ui dropdown">
                          <option value="jpg">JPG</option>
                          <option value="png">PNG</option>
                          <option value="gif">GIF</option>
                          <option value="webp">WEBP</option>
                          <option value="bmp">BMP</option>
                        </select>
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">目标图片格式，JPG适合照片（有损压缩），PNG适合图标（无损，支持透明），WEBP适合网页（体积小），推荐：JPG（照片）或 PNG（图标）</p>
                      </div>
                      <div class="field">
                        <label>质量 <span style="color: #999; font-weight: normal;">(%)</span></label>
                        <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.quality" min="1" max="100">
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">图片压缩质量（仅对JPG/WEBP有效），范围：1-100，推荐：85-95（数值越高质量越好但文件越大）</p>
                      </div>
                    </template>
                    
                    <template v-else-if="state.operationChain[state.selectedOperationIndex].type === 'watermark'">
                      <div class="field">
                        <label>类型</label>
                        <select v-model="state.operationChain[state.selectedOperationIndex].params.type" class="ui dropdown">
                          <option value="text">文字</option>
                          <option value="image">图片</option>
                        </select>
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">选择水印类型，文字水印适合添加版权信息，图片水印适合添加Logo</p>
                      </div>
                      <div v-if="state.operationChain[state.selectedOperationIndex].params.type === 'text'" class="field">
                        <label>文字</label>
                        <input type="text" v-model="state.operationChain[state.selectedOperationIndex].params.text" placeholder="水印文字">
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">要显示的水印文字内容，推荐：版权信息、品牌名称等</p>
                      </div>
                      <div class="field">
                        <label>位置</label>
                        <select v-model="state.operationChain[state.selectedOperationIndex].params.position" class="ui dropdown">
                          <option value="top-left">左上</option>
                          <option value="top-right">右上</option>
                          <option value="bottom-left">左下</option>
                          <option value="bottom-right">右下</option>
                          <option value="center">居中</option>
                        </select>
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">水印在图片上的位置，推荐：bottom-right（右下角，不遮挡主要内容）</p>
                      </div>
                      <div class="field">
                        <label>透明度</label>
                        <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.opacity" min="0" max="1" step="0.1">
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">水印的透明度，范围：0-1（0完全透明，1完全不透明），推荐：0.3-0.7（半透明效果）</p>
                      </div>
                    </template>
                    
                    <template v-else-if="state.operationChain[state.selectedOperationIndex].type === 'adjust'">
                      <div class="three fields">
                        <div class="field">
                          <label>亮度</label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.brightness" placeholder="亮度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">调整图片亮度，范围：-100到100，0为原始亮度，推荐：-20到20（负数变暗，正数变亮）</p>
                        </div>
                        <div class="field">
                          <label>对比度</label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.contrast" placeholder="对比度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">调整图片对比度，范围：-100到100，0为原始对比度，推荐：-20到20（负数降低，正数增强）</p>
                        </div>
                        <div class="field">
                          <label>饱和度</label>
                          <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.saturation" placeholder="饱和度">
                          <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">调整图片色彩饱和度，范围：-100到100，0为原始饱和度，推荐：-50到50（负数变灰，正数更鲜艳）</p>
                        </div>
                      </div>
                    </template>
                    
                    <!-- filter 类型的操作（如 filter-blur, filter-sharpen 等） -->
                    <template v-else-if="isFilterOperation(state.operationChain[state.selectedOperationIndex])">
                      <div class="field">
                        <label>强度</label>
                        <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.intensity" min="0" max="10" step="0.1">
                        <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">滤镜效果的强度，范围：0-10，推荐：1-3（数值越大效果越明显）</p>
                      </div>
                    </template>
                    
                    <!-- effects 类型的操作（如 effects-grayscale, effects-blur 等） -->
                    <template v-else-if="isEffectsOperation(state.operationChain[state.selectedOperationIndex])">
                      <!-- 根据效果类型显示不同参数 -->
                      <template v-if="getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex])">
                        <!-- 需要 radius 和 sigma 的效果 -->
                        <template v-if="needsRadius(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex])) && needsSigma(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="two fields">
                            <div class="field">
                              <label>半径</label>
                              <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.radius" placeholder="半径">
                              <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">效果的影响半径（像素），范围：1-100，推荐：5-20（数值越大影响范围越广）</p>
                            </div>
                            <div class="field">
                              <label>Sigma</label>
                              <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.sigma" placeholder="Sigma">
                              <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">高斯模糊的标准差，范围：0.1-10，推荐：1-5（数值越大模糊程度越高）</p>
                            </div>
                          </div>
                        </template>
                        
                        <!-- 只需要 radius 的效果 -->
                        <template v-else-if="needsRadius(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="field">
                            <label>半径</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.radius" placeholder="半径">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">效果的影响半径（像素），范围：1-100，推荐：5-20（数值越大影响范围越广）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 intensity 的效果 -->
                        <template v-if="needsIntensity(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="field">
                            <label>强度</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.intensity" placeholder="强度">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">效果的强度，范围：0-100，推荐：20-80（数值越大效果越明显）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 value 的效果 -->
                        <template v-if="needsValue(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="field">
                            <label>数值</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.value" placeholder="数值">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">效果的数值参数，范围：-100到100，推荐：-50到50（根据效果类型调整）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 size 的效果 (mosaic, pixelate) -->
                        <template v-if="needsSize(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="field">
                            <label>大小</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.size" placeholder="大小">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">像素块或马赛克的大小（像素），范围：2-50，推荐：5-20（数值越大块越大）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 color 的效果 -->
                        <template v-if="needsColor(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="field">
                            <label>颜色</label>
                            <input type="color" v-model="state.operationChain[state.selectedOperationIndex].params.color" placeholder="颜色">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">效果使用的颜色，点击选择或输入十六进制颜色值（如 #FF0000）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 angle 的效果 -->
                        <template v-if="needsAngle(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="field">
                            <label>角度</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.angle" placeholder="角度">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">效果的角度（度），范围：-360到360，推荐：0-180（根据效果类型调整）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 amount 的效果 -->
                        <template v-if="needsAmount(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="field">
                            <label>数量</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.amount" placeholder="数量" step="0.1">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">效果的数量参数，范围：0-10，推荐：0.5-5（根据效果类型调整，数值越大效果越强）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 threshold 的效果 -->
                        <template v-if="needsThreshold(getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]))">
                          <div class="field">
                            <label>阈值</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.threshold" placeholder="阈值">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">效果的阈值，范围：0-255，推荐：128（用于二值化处理，小于阈值为黑，大于为白）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 amplitude 和 wavelength 的效果 (wave) -->
                        <template v-if="getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]) === 'wave'">
                          <div class="two fields">
                            <div class="field">
                              <label>振幅</label>
                              <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.amplitude" placeholder="振幅">
                              <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">波浪的振幅（像素），范围：1-100，推荐：10-50（数值越大波浪起伏越大）</p>
                            </div>
                            <div class="field">
                              <label>波长</label>
                              <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.wavelength" placeholder="波长">
                              <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">波浪的波长（像素），范围：10-500，推荐：50-200（数值越大波浪越宽）</p>
                            </div>
                          </div>
                        </template>
                        
                        <!-- 需要 levels 的效果 (posterize) -->
                        <template v-if="getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]) === 'posterize'">
                          <div class="field">
                            <label>色阶数</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.levels" placeholder="色阶数">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">颜色量化后的色阶数量，范围：2-256，推荐：4-16（数值越小颜色越少，海报效果越明显）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 colors 的效果 (quantize) -->
                        <template v-if="getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]) === 'quantize'">
                          <div class="field">
                            <label>颜色数</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.colors" placeholder="颜色数">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">量化后的颜色数量，范围：2-256，推荐：8-64（数值越小颜色越少，简化效果越明显）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 method 和 intensity 的效果 (grayscale) -->
                        <template v-if="getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]) === 'grayscale'">
                          <div class="field">
                            <label>方法</label>
                            <select v-model="state.operationChain[state.selectedOperationIndex].params.method" class="ui dropdown">
                              <option value="Rec601Luma">Rec601Luma</option>
                              <option value="Rec709Luma">Rec709Luma</option>
                              <option value="average">平均值</option>
                              <option value="luminance">亮度</option>
                              <option value="desaturate">去饱和</option>
                            </select>
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">黑白化转换方法，推荐：Rec709Luma（现代标准）或 average（简单平均）</p>
                          </div>
                          <div class="field">
                            <label>强度 (%)</label>
                            <input type="number" v-model.number="state.operationChain[state.selectedOperationIndex].params.intensity" min="0" max="100" placeholder="强度">
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">黑白化强度，范围：0-100，推荐：100（完全黑白化）</p>
                          </div>
                        </template>
                        
                        <!-- 需要 noiseType 的效果 (noise) -->
                        <template v-if="getEffectKeyFromOperation(state.operationChain[state.selectedOperationIndex]) === 'noise'">
                          <div class="field">
                            <label>噪点类型</label>
                            <select v-model="state.operationChain[state.selectedOperationIndex].params.noiseType" class="ui dropdown">
                              <option value="Uniform">均匀</option>
                              <option value="Gaussian">高斯</option>
                              <option value="Multiplicative">乘法</option>
                              <option value="Impulse">脉冲</option>
                              <option value="Laplacian">拉普拉斯</option>
                              <option value="Poisson">泊松</option>
                            </select>
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.25rem;">噪点的分布类型，推荐：Gaussian（高斯，自然）或 Uniform（均匀，随机）</p>
                          </div>
                        </template>
                      </template>
                    </template>
                  </div>
                </div>
              </div>
              <div v-else class="ui message">
                <p>还没有添加任何操作，请点击上方按钮添加操作</p>
              </div>
            </div>

            <!-- 实时参数预览 -->
            <div class="ui segment compact-segment">
              <h3 class="ui dividing header" style="font-size: 0.95em; margin-bottom: 0.75rem;">请求参数预览</h3>
              <pre v-if="getRequestPayload()" style="background: #f5f5f5; padding: 0.75rem; border-radius: 4px; overflow-x: auto; font-size: 0.85em;">{{ JSON.stringify(getRequestPayload(), null, 2) }}</pre>
              <p v-else style="color: #999; font-size: 0.85em;">请先上传图片并添加操作</p>
            </div>

            <!-- 处理按钮和结果 -->
            <div class="ui segment compact-segment">
              <button class="ui primary button" :class="{ loading: state.loading.chainProcess }" @click="handleChainProcess" :disabled="!state.chainProcessFilename || state.operationChain.length === 0 || state.loading.chainProcess">
                <i class="play icon"></i> 执行链式处理
              </button>
              <button v-if="state.chainProcessResultImage" class="ui button" @click="useChainProcessAsSource">
                <i class="refresh icon"></i> 使用结果作为新源
              </button>
              
              <div v-if="state.chainProcessResultImage" class="image-comparison-container" style="margin-top: 1rem;">
                <div class="image-comparison-item">
                  <h4>原图</h4>
                  <img :src="state.chainProcessImage" alt="原图" style="max-width: 100%; border-radius: 6px;">
                </div>
                <div class="image-comparison-item">
                  <h4>处理后</h4>
                  <img :src="state.chainProcessResultImage" alt="处理后" style="max-width: 100%; border-radius: 6px;">
                  <div style="margin-top: 0.75rem; text-align: center;">
                    <a :href="state.chainProcessResultImage" :download="state.chainProcessResultFilename" class="ui primary button">
                      <i class="download icon"></i> 下载图片
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 文件管理 -->
        <div class="view-container" :class="{ active: state.currentView === 'files' }">
          <div class="section">
            <h1 class="ui header">
              <i class="folder icon"></i>
              <div class="content">
                文件管理
                <div class="sub header">查看和管理 uploads 和 output 目录下的文件</div>
              </div>
            </h1>

            <!-- 目录切换 -->
            <div class="ui segment compact-segment">
              <h3 class="ui dividing header" style="font-size: 0.95em; margin-bottom: 0.75rem;">选择目录</h3>
              <div class="ui two buttons">
                <button 
                  class="ui button" 
                  :class="{ primary: state.filesCurrentDirectory === 'uploads' }"
                  @click="switchFilesDirectory('uploads')"
                  :disabled="state.filesLoading.uploads"
                >
                  <i class="upload icon"></i> 上传文件 (uploads)
                </button>
                <button 
                  class="ui button" 
                  :class="{ primary: state.filesCurrentDirectory === 'output' }"
                  @click="switchFilesDirectory('output')"
                  :disabled="state.filesLoading.output"
                >
                  <i class="download icon"></i> 输出文件 (output)
                </button>
              </div>
            </div>

            <!-- 文件列表 -->
            <div class="ui segment compact-segment">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                <h3 class="ui dividing header" style="font-size: 0.95em; margin: 0;">
                  {{ state.filesCurrentDirectory === 'uploads' ? '上传文件' : '输出文件' }}列表
                </h3>
                <div>
                  <button 
                    class="ui small button" 
                    @click="loadFilesList(state.filesCurrentDirectory)"
                    :class="{ loading: state.filesLoading[state.filesCurrentDirectory] }"
                    :disabled="state.filesLoading[state.filesCurrentDirectory]"
                  >
                    <i class="refresh icon"></i> 刷新
                  </button>
                  <button 
                    class="ui small red button" 
                    @click="clearDirectory(state.filesCurrentDirectory)"
                    :disabled="state.filesLoading[state.filesCurrentDirectory] || state.filesList[state.filesCurrentDirectory].length === 0"
                  >
                    <i class="trash icon"></i> 清空目录
                  </button>
                </div>
              </div>

              <!-- 统计信息 -->
              <div v-if="state.filesStats[state.filesCurrentDirectory]" class="ui small message" style="padding: 0.5rem; margin-bottom: 0.75rem;">
                <p style="margin: 0.25rem 0; font-size: 0.85em;">
                  <strong>文件数量:</strong> {{ state.filesStats[state.filesCurrentDirectory].count }} 个
                  <span style="margin-left: 1rem;">
                    <strong>总大小:</strong> {{ state.filesStats[state.filesCurrentDirectory].totalSizeFormatted }}
                  </span>
                </p>
              </div>

              <!-- 文件列表 -->
              <div v-if="state.filesLoading[state.filesCurrentDirectory]" class="ui active centered inline loader"></div>
              
              <div v-else-if="state.filesList[state.filesCurrentDirectory].length === 0" class="ui message">
                <p>目录为空，暂无文件</p>
              </div>

              <div v-else class="ui relaxed divided list" style="max-height: calc(100vh - 280px); overflow-y: auto; overflow-x: hidden;">
                <div 
                  v-for="file in state.filesList[state.filesCurrentDirectory]" 
                  :key="file.name"
                  class="item"
                  style="padding: 0.75rem 0; display: flex; align-items: center; justify-content: space-between;"
                >
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="file image icon" style="color: #2185d0;"></i>
                      <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; word-break: break-all;">{{ file.name }}</div>
                        <div style="font-size: 0.85em; color: #999; margin-top: 0.25rem;">
                          {{ file.sizeFormatted }} · 
                          {{ new Date(file.modified).toLocaleString('zh-CN') }}
                        </div>
                      </div>
                    </div>
                  </div>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button 
                      class="ui mini button"
                      @click="showFilePreview(file)"
                      style="white-space: nowrap;"
                    >
                      <i class="eye icon"></i> 查看
                    </button>
                    <a 
                      :href="file.url" 
                      :download="file.name"
                      class="ui mini button"
                      style="white-space: nowrap;"
                    >
                      <i class="download icon"></i> 下载
                    </a>
                    <button 
                      class="ui mini red button"
                      @click="deleteFile(state.filesCurrentDirectory, file.name)"
                      style="white-space: nowrap;"
                    >
                      <i class="trash icon"></i> 删除
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </main>

      <!-- 右侧调试输出面板 -->
      <aside class="debug-panel">
        <div class="debug-panel-header">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
            <h3 class="ui header" style="margin: 0; font-size: 1em;">
              <i class="bug icon"></i>
              <div class="content">
                调试输出
                <div class="sub header" style="font-size: 0.75em;">实时调试信息和日志</div>
              </div>
            </h3>
            <button class="ui tiny button" @click="clearDebugLog">清空</button>
          </div>
          <div class="debug-tabs">
            <div 
              v-for="tab in debugTabs" 
              :key="tab.id"
              class="debug-tab"
              :class="{ active: state.currentDebugTab === tab.id }"
              @click="state.currentDebugTab = tab.id"
            >
              {{ tab.name }}
              <span v-if="tab.count > 0" style="margin-left: 0.25rem;">({{ tab.count }})</span>
            </div>
          </div>
        </div>
        <div class="debug-panel-content">
          <div class="debug-log">
            <div v-if="filteredDebugLogs.length === 0" style="color: #888; text-align: center; padding: 2rem;">
              暂无调试信息
            </div>
            <div 
              v-for="(log, index) in filteredDebugLogs" 
              :key="index"
              class="debug-log-item"
            >
              <div class="debug-log-time">{{ log.time }}</div>
              <div class="debug-log-content" :class="log.type">{{ log.content }}</div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- 文件预览弹窗 -->
    <div v-if="state.filePreviewVisible" class="file-preview-modal" @click.self="closeFilePreview">
      <div class="file-preview-content">
        <div class="file-preview-header">
          <h3 style="margin: 0; flex: 1;">{{ state.filePreviewFile?.name }}</h3>
          <button class="ui icon button" @click="closeFilePreview" style="margin-left: 1rem;">
            <i class="close icon"></i>
          </button>
        </div>
        <div class="file-preview-body">
          <img 
            v-if="state.filePreviewFile && !state.imageLoadError" 
            :src="state.filePreviewFile.url" 
            :alt="state.filePreviewFile.name"
            style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 4px;"
            @error="handleImageError"
            @load="state.imageLoadError = false"
          >
          <div v-if="state.imageLoadError" class="ui message" style="text-align: center; padding: 2rem;">
            <p>无法加载图片，可能不是有效的图片文件</p>
          </div>
        </div>
        <div class="file-preview-footer">
          <div style="font-size: 0.85em; color: #999; margin-bottom: 0.5rem;">
            <span>大小: {{ state.filePreviewFile?.sizeFormatted }}</span>
            <span style="margin-left: 1rem;">修改时间: {{ state.filePreviewFile ? new Date(state.filePreviewFile.modified).toLocaleString('zh-CN') : '' }}</span>
          </div>
          <div>
            <a 
              :href="state.filePreviewFile?.url" 
              :download="state.filePreviewFile?.name"
              class="ui primary button"
            >
              <i class="download icon"></i> 下载
            </a>
            <button class="ui button" @click="closeFilePreview">
              关闭
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Semantic UI JS -->
  <script src="/lib/semantic.js"></script>
  
  <!-- 操作配置统一文件 -->
  <script src="/config/operations.config.js"></script>
  
  <!-- 主应用脚本 -->
  <script src="app.js"></script>
</body>
</html>
